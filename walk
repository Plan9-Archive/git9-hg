#!/bin/rc

fn usage{
	echo usage: $argv0 [-c] >[2=1]
	echo '	-c:	exit with status "dirty" if files changed.' >[2=1]
	echo '	-b br:	walk based on branch br'
	echo '	-q	suppress status character'
	echo '		supresses other output' >[2=1]
	exit usage
}

fn decho{
	if(~ $quiet true)
		shift
	if(~ $cleanonly '')
		echo $*
}

if(! cd `{git/conf -r})
	exit 'not in git repository'

if(! test -e /mnt/git/ctl)
	git/fs

quiet=''
cleanonly=''
result=''
branch=`{awk '$1=="branch"{print $2}' < /mnt/git/ctl}
while(~ $1 -*){
	switch($1){
	case -c; cleanonly=true;
	case -b; branch=$2; shift
	case -q; quiet=true
	case --; break;
	case *; usage
	}
	shift
}

nl='
'
indexed=`$nl{walk -f .git/index9/tracked /mnt/git/HEAD/tree |
	sed 's@^(.git/index9/(tracked|removed)|/mnt/git/HEAD/tree)/*@@' |
	sort | uniq}

for(f in $indexed){
	if(! test -f $f || test -f .git/index9/removed/$f){
		decho R $f
		result=dirty
	}
	if not if(! cmp $f /mnt/git/branch/$branch/tree/$f){
		decho D $f
		result=dirty
	}
	if not
		decho T $f
}

exit $result
