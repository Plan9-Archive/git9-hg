#!/bin/rc

rfork e

fn usage{
	echo git/diff '[-b branch] [file ...]' >[2=1]
	exit usage
}

if(! cd `{git/conf -r}){
	echo 'not a git repository' >[1=2]
	exit notgit
}
if(! test -f /mnt/git/ctl)
	git/fs

while(~ $1 -*){
	switch($1){
	case -b; branch=$2; shift
	case *; usage
	}
	shift
}

if(~ $#branch 0)
	branch=`{git/branch}
dirty=`{git/walk | awk '/^D/ {print $2}'}
if(! ~ $#* 0){
	echo $dirty | sed 's/ /\n/g' | sort >/tmp/git.diff.dirty
	echo $* | sed 's/ /\n/g' | sort >/tmp/git.diff.args
	dirty=`{join /tmp/git.diff.dirty /tmp/git.diff.args}
}
for(f in $dirty)
	ape/diff -up /mnt/git/branch/$branch/tree/$f $f

