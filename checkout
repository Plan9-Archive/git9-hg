#!/bin/rc -xe

rfork en

nl='
'
files=$*
branch=HEAD
if(~ $#files 0)
	files=`$nl{git/walk -c}
if(~ $#files 0)
	exit

if(! cd `{git/conf -r}){
	echo 'not a git repository' >[1=2]
	exit notgit
}

while(~ $1 -* && ! ~ $1 --){
	switch($1){
	case -b; branch=$1; shift
	case *; usage
	}
	shift
}

git/fs
tree=/mnt/git/$branch/tree
rm -rf .git/index9/tracked/^$files
rm -rf .git/index9/removed/^$files
rm -f $files
for(f in $files){
	idx=.git/index9/tracked/$f
	mkdir -p `{basename -d $f}
	mkdir -p `{basename -d $idx}
	walk -eq $f > $idx
	cp $tree/$f $f
}
